<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>{{.Branding.Title}}</title>
    {{template "headImports" .VersionTag}}
    <script src="/static/assets/ts-dist/home.bundle.js?v={{if .}}{{.}}{{else}}development{{end}}"></script>
    <meta name="description" content="{{.Branding.Description}}"/>
</head>
{{- /*gotype: github.com/joschahenningsen/TUM-Live/web.IndexData*/ -}}
{{$user := .TUMLiveContext.User}}
{{$currentYear := .CurrentYear}}
{{$currentTerm := .CurrentTerm}}
<body x-data="home.body()"
      @popstate.window="onPopState"
      class="h-screen flex flex-col items-stretch bg-white dark:bg-secondary">
<div :style="`width: ${loadingIndicator}%`" class="bg-blue-500/50 h-px fixed top-0 transition-all duration-300"></div>
<header x-data="home.header()"
        class="text-3 flex z-50 w-full items-center justify-between px-6 py-2 h-16 shrink-0 grow-0">
    <div class="flex items-center mr-4">
        <button type="button" id="open-sidenav" title="Open Sidenav" @click="navigation.toggle()"
                class="mr-4 text-lg md:hidden">
            <i class="fa-solid fa-bars"></i>
        </button>
        <button type="button" id="logo" title="Start" @click="showMain()">
            <img src="/logo.svg" width="42" alt="TUM-Live Logo">
        </button>
    </div>
    {{/*template "search"*/}}
    <div id="user-context" class="flex items-center space-x-6 ms-auto">
        {{template "notifications"}}
        {{if not $user}}
            <a href="/login"
               class="rounded-full px-3 py-1 text-sm font-semibold text-white bg-blue-500 dark:bg-indigo-600">Login</a>
        {{else}}
            <div>
                <button type="button" @click="userContext.toggle(true)"
                        class="flex items-center justify-center bg-blue-500 dark:bg-indigo-600 rounded-full h-[32px] w-[32px]">
                    <span class="text-white font-semibold uppercase">{{printf "%.1s" $user.GetPreferredName}}</span>
                </button>
                <div class="relative">
                    <div x-cloak x-show="userContext.value"
                         @click.outside="userContext.toggle();"
                         class="absolute top-full right-[50%] mt-2 shadow rounded-lg h-fit bg-white border
                         dark:bg-secondary dark:border-gray-800 overflow-hidden text-sm w-56">
                        <div class="p-2 border-b dark:border-gray-800">
                            <p class="font-semibold">Signed in as</p>
                            <span>@{{$user.Name}}</span>
                        </div>
                        <nav class="d-grid gap-3 font-light">
                            {{if or (eq $user.Role 1) (eq $user.Role 2) }}
                                <a href="/admin"
                                   class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 my-2">
                                    <i class="fa-solid fa-hammer mr-4"></i>
                                    <p>Admin</p>
                                </a>
                                <div class="border-b dark:border-gray-800"></div>
                            {{end}}
                            <div>
                                <button type="button"
                                        class="flex items-center p-2 w-full hover:bg-gray-100 dark:hover:bg-gray-800 my-2"
                                        @click="themePicker.toggle()">
                                    <i class="fa-regular fa-moon mr-4"></i>
                                    <span>Theme</span>
                                    <i class="fa-solid ml-auto"
                                       :class="themePicker.value ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                                {{template "theme-picker"}}
                            </div>
                            <a href="/settings"
                               class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 my-2">
                                <i class="fa-solid fa-gear mr-4"></i>
                                <p>Settings</p>
                            </a>
                            <div class="border-b dark:border-gray-800"></div>
                            <a href="https://github.com/joschahenningsen/TUM-Live"
                               target="_blank"
                               class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 my-2">
                                <i class="fa-regular fa-comment mr-4"></i>
                                <p>Send Feedback</p>
                            </a>
                            <a href="https://github.com/joschahenningsen/TUM-Live/issues/new?assignees=&labels=&template=bug_report.md&title="
                               class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 my-2"
                               target="_blank">
                                <i class="fa-brands fa-github mr-4"></i>
                                <p>Report problem</p>
                            </a>
                            <div class="border-b dark:border-gray-800"></div>
                            <a href="/logout"
                               class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 my-2">
                                <i class="fa-solid fa-sign-out mr-4"></i>
                                <p>Logout</p>
                            </a>
                        </nav>
                    </div>
                </div>
            </div>
        {{end}}
    </div>
</header>
<article class="flex grow h-full overflow-y-scroll">
    <section id="side-navigation" class="sticky top-0 overflow-y-scroll font-light px-5 text-3 shrink-0 lg:w-80 md:w-56 md:block"
             :class="navigation.value ? 'w-full' : 'hidden'">
        <article class="grid py-4">
            <header class="flex items-center px-3 pb-2 font-semibold">
                <i class="text-xs fa-solid fa-calendar mr-2"></i>
                Semesters
            </header>
            {{template "semester-picker" .}}
        </article>
        <template x-if="userCourses.length > 0">
            <article class="grid py-4 border-t dark:border-gray-800">
                <header class="flex items-center px-3 pb-2 font-semibold">
                    <i class="text-xs fa-solid fa-graduation-cap mr-2"></i>
                    My Courses
                </header>
                <template x-for="(course, i) in userCourses.slice(0, 5)" :key="course.ID">
                    <a class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2 hover:underline"
                       :href="`/course/${course.year}/${course.term}/${course.slug}`"
                       x-text="course.name">
                    </a>
                </template>
                <template x-if="userCourses.length > 5 && view !== home.Views.UserCourses">
                    <button @click="showUserCourses()"
                            class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2 w-full">
                        <i class="fa-solid fa-chevron-right text-xs mr-2"></i>
                        <span>Show all my courses</span>
                    </button>
                </template>
            </article>
        </template>
        <article class="grid py-4 border-t dark:border-gray-800">
            <header class="flex items-center px-3 pb-2 font-semibold">
                <i class="text-xs fa-solid fa-chalkboard mr-2"></i>
                Public Courses
            </header>
            <template x-for="(course, i) in publicCourses.slice(0, 5)" :key="course.ID">
                <a class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2 hover:underline"
                   :href="`/course/${course.year}/${course.term}/${course.slug}`"
                   x-text="course.name">
                </a>
            </template>
            <template x-if="userCourses.length > 5 && view !== home.Views.PublicCourses">
                <button @click="showPublicCourses()"
                        class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2 w-full">
                    <i class="fa-solid fa-chevron-right text-xs mr-2"></i>
                    <span>Show all public courses</span>
                </button>
            </template>
        </article>
        <footer class="grid gap-2 py-4 px-3 border-t dark:border-gray-800 md:hidden">
            <a class="text-sm font-light text-5" href="/about">About</a>
            <a class="text-sm font-light text-5" href="/privacy">Data Privacy</a>
            <a class="text-sm font-light text-5" href="/imprint">Imprint</a>
            <a class="text-sm font-light text-5" href="/public/licenses.txt">
                We <i class="fas fa-heart text-blue-500 dark:text-indigo-600"></i> OpenSource</a>
        </footer>
    </section>
    <article id="content-wrapper" class="text-3 p-4 grow" :class="{'hidden' : navigation.value}">
        <template x-if="view === home.Views.PublicCourses">
            {{template "public-courses"}}
        </template>
        <template x-if="view === home.Views.UserCourses">
            {{template "user-courses"}}
        </template>
        <template x-if="view === home.Views.Main">
            <article id = "main-view">
                {{if .TUMLiveContext}}
                    {{if .TUMLiveContext.User.Name}}
                        <h1 id="greeting" class="font-bold mb-4 px-3">
                            {{.TUMLiveContext.User.GetPreferredGreeting}} {{.TUMLiveContext.User.GetPreferredName}},
                            nice to
                            see
                            you! ðŸ‘‹
                        </h1>
                    {{end}}
                {{end}}
                <div class="grid gap-y-8 pb-4">
                    {{template "livestreams"}}
                    {{template "live-today"}}
                    {{template "recent-vods"}}
                </div>
            </article>
        </template>
    </article>
</article>
<footer id="desktop-footer"
        class="w-full flex justify-between space-x-3 py-4 px-8 items-center bg-gray-100 dark:bg-secondary-light hidden md:flex">
    <div class="flex space-x-3">
        <a class="text-sm font-light text-5" href="/about">About</a>
        <a class="text-sm font-light text-5" href="/privacy">Data Privacy</a>
        <a class="text-sm font-light text-5" href="/imprint">Imprint</a>
    </div>
    <a class="text-sm font-light text-5" href="/public/licenses.txt">
        We <i class="fas fa-heart text-blue-500 dark:text-indigo-600"></i> OpenSource</a>
</footer>
</body>
</html>

{{define "notifications"}}
    <div id="notifications"
         class="relative" x-init="notifications.fetchNotifications();"
         @keyup.escape="toggleNotification()">
        <button title="Show Notifications"
                class="transition-colors duration-200 hover:text-gray-600 dark:hover:text-white text-gray-400 relative w-4"
                type="button" @click="toggleNotification(true);">
            <span x-cloak x-show="notifications.hasNewNotifications()"
                  class="bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full absolute -top-1 -right-1 h-3 w-3 border-2 border-white dark:border-secondary"> </span>
            <i class="fa-solid fa-bell"></i>
        </button>
        <div x-cloak x-show="notification.value"
             @click.outside="toggleNotification();"
             class="text-3 text-sm origin-top-right absolute right-0 mt-4 shadow-sm rounded-lg h-fit bg-white border w-96
                        dark:bg-secondary dark:border-gray-800 shadow">
            <div class="border-b dark:border-gray-800 py-2 px-4">
                <p>Notifications</p>
            </div>
            <div class="w-full min-h-30 max-h-60 overflow-y-scroll py-2">
                <div x-cloak x-show="notifications.empty()" class="py-4 relative text-3 text-center">
                    <span class="font-semibold">No notifications yet :)</span>
                </div>
                <div class="grid">
                    <template x-for="(notification, i) of notifications.getAll()">
                        <div class="px-4 py-3 border-b dark:border-gray-800 last:border-0 relative">
                            <p class="font-semibold mb-2" x-show="notification.title !== undefined"
                               x-text="notification.title"></p>
                            <div class="notificationBody" x-html="notification.body"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
{{end}}

{{define "theme-picker"}}
    <div x-cloak x-show="themePicker.value" class="grid gap-1">
        <template x-for="[modeId, mode] of Object.entries($store.theme.modes)" :key="modeId">
            <button type="button" tabindex="0"
                    class="text-left hover:bg-gray-100 dark:hover:bg-gray-800 py-2 px-4"
                    :class="{'bg-gray-100 dark:bg-gray-800': modeId === $store.theme.activeMode}"
                    @click="$store.theme.setMode(modeId)"
                    x-text="mode.name">
            </button>
        </template>
    </div>
{{end}}

{{define "search"}}
    <div id="search" class="h-10 w-96">
        <div class="flex items-center rounded-full bg-gray-100 dark:bg-gray-800 text-sm py-1 h-full">
            <i class="fa-solid fa-search pl-3 text-xs text-7"></i>
            <input class="px-3 outline-none border-none bg-transparent h-full w-full grow" type="text"
                   placeholder="Search in lectures">
        </div>
    </div>
{{end}}

{{define "semester-picker"}}
    <span class="text-sm bg-gray-100 dark:bg-gray-800 rounded-lg text-left px-3 py-2 mb-1"
          x-text="semesters[selectedSemesterIndex]?.FriendlyString"></span>
    <template x-if="allSemesters.value">
        <template x-for="(s, i) in semesters">
            <button type="button" @click="switchSemester(s.Year, s.TeachingTerm)"
                    class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg text-left px-3 py-2"
                    x-text="s.FriendlyString"></button>
        </template>
    </template>
    <button @click="allSemesters.toggle()"
            class="text-sm hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2 w-full">
        <i class="fa-solid text-xs mr-2" :class="allSemesters.value ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        <span x-text="allSemesters.value ? 'Show less' : 'Show all'"></span>
    </button>
{{end}}

{{define "livestreams"}}
    <template x-if="livestreams.length > 0">
        <article id="livestreams">
            <div class="px-3 py-1 mx-3 bg-danger text-white text-sm w-fit font-semibold uppercase rounded animate-pulse">
                Live
            </div>
            <section class="grid xl:grid-cols-3 lg:grid-cols-2 grid-cols-1">
                <template x-for="(livestream, i) in livestreams" :key="livestream.Stream.ID">
                    <article class="p-3 lg:col-span-1 col-span-full"
                             :id="`livestream-${livestream.Stream.ID}`">
                        <div class="h-56 relative mb-2">
                            <div class="absolute right-2 top-1 flex items-center space-x-2 text-xs font-semibold text-white z-40">
                                <template x-if="livestream.Course.Visibility === 'hidden'">
                                    <span class="rounded-full px-2 py-1 bg-indigo-900">Hidden</span>
                                </template>
                                <template x-if="livestream.LectureHall !== null">
                                    <a class="rounded-full px-2 py-1 bg-black"
                                       :href="`https://nav.tum.de/room/${livestream.LectureHall.Name}`">
                                        <i class="fas fa-location-pin mr-1"></i>
                                        <span x-text="livestream.LectureHall.Name"></span>
                                    </a>
                                </template>
                            </div>
                            <a :href="`/w/${livestream.Course.Slug}/${livestream.Stream.ID}`">
                                <div style="background-image:url('https://streams.tum.de/Mediasite/FileServer/Presentation/ec92304e4558492b91635053e1cfe1161d/1cbd7a07-44e9-45cf-8420-8f2964750278.jpg')"
                                     class="bg-gray-100 dark:bg-gray-800 h-full rounded-lg mb-2 bg-cover transition-all duration-500 hover:shadow-xl"></div>
                            </a>
                        </div>
                        <div>
                            <a class="block text-sm text-5 hover:bg-gray-50 dark:hover:bg-gray-800 px-2 rounded"
                               :href="`/course/${livestream.Course.Year}/${livestream.Course.TeachingTerm}/${livestream.Course.Slug}`"
                               x-text="livestream.Course.Name"></a>
                            <a class="font-medium block px-2 hover:underline"
                               :href="`/w/${livestream.Course.Slug}/${livestream.Stream.ID}`"
                               x-text="livestream.Stream.Name"></a>
                        </div>
                        <div class="flex items-center text-sm px-2">
                            <span class="font-light" x-text="livestream.Stream.FriendlyDateString"></span>
                        </div>
                    </article>
                </template>
            </section>
        </article>
    </template>
{{end}}

{{define "live-today"}}
    <template x-if="liveToday.length > 0">
        <article id="live-today" class="px-3">
            <h3 class="font-bold">Today</h3>
            <section class="grid gap-3 px-2">
                <template x-for="(course, i) in liveToday" :key="course.ID">
                    <article class="border-b dark:border-gray-800 last:border-0 py-2 px-1">
                        <a class="block text-3 font-semibold hover:underline" x-text="course.name"
                           :href="`/course/${course.year}/${course.term}/${course.slug}`"></a>
                        <div class="flex items-center text-sm text-5 font-light">
                            <a :href="`/w/${course.slug}/${course.nextLecture.ID}`">
                                <i class="fa-solid fa-square-up-right"></i>
                                <span class="hover:underline"
                                      x-text="`Next lecture: ${new Date(course.nextLecture.Start).toLocaleString()}`"></span>
                            </a>
                        </div>
                    </article>
                </template>
            </section>
        </article>
    </template>
{{end}}

{{define "recent-vods"}}
    <template x-if="recently.length > 0">
        <article id="recent-vods">
            <h3 class="font-bold px-3">Recent VODs</h3>
            <section class="grid xl:grid-cols-4 lg:grid-cols-2 grid-cols-1">
                <template x-for="(course, i) in recently" :key="course.ID">
                    <article class="lg:col-span-1 col-span-full p-3">
                        <a :href="`/w/${course.slug}/${course.lastLecture.ID}`" class="block mb-2">
                            <div style="background-image:url('https://www.tum-universitaetsstiftung.de/fileadmin/_processed_/d/f/csm_20190712_9_9b38ba8a75.jpg')"
                                 class="relative bg-gray-100 dark:bg-gray-800 h-40 rounded-lg transition-all duration-500 hover:shadow-lg bg-cover">
                                <div :id="`vod-progress-${course.lastLecture.ID}`" class="absolute bottom-0 w-full">
                                    <div class="relative w-full h-2 bg-gray-500/50 rounded-b-lg">
                                        <template x-if="course.lastLecture.progress !== undefined">
                                            <span :style="`width: ${course.lastLecture.progress.percentage}%`"
                                                  class="absolute left-0 bg-blue-500 dark:bg-indigo-600 h-2 rounded-bl-lg"
                                                  :class="{'rounded-br-lg': course.lastLecture.progress.percentage === 100}"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <a class="inline-block text-xs text-5 hover:bg-gray-50 dark:hover:bg-gray-800 px-1 rounded w-fit"
                           x-text="course.name"
                           :href="`/course/${course.year}/${course.term}/${course.slug}`"></a>
                        <a class="font-semibold block hover:underline px-1"
                           :href="`/w/${course.slug}/${course.lastLecture.ID}`"
                           x-text="course.lastLecture.Name"></a>
                        <span class="font-light text-xs text-5 px-1"
                              x-text="new Date(course.lastLecture.Start).toLocaleString()"></span>
                    </article>
                </template>
            </section>
        </article>
    </template>
{{end}}

{{define "user-courses"}}
    <article id="user-courses">
        <header class="flex items-center justify-between mb-4">
            <h1 id="my-courses-head" class="flex items-center font-bold px-3">
                <i class="text-base fa-solid fa-graduation-cap mr-2"></i>
                My Courses
            </h1>
            <button type="button" title="Navigate to start"
                    class="text-3 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full px-2 py-1"
                    @click="showMain()">
                <i class="fa-solid fa-undo mr-2"></i>
                <span>Go back</span>
            </button>
        </header>
        <section class="grid gap-3 pb-4">
            <template x-for="(course, i) in userCourses" :key="course.ID">
                <article class="hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2">
                    <a class="block text-3 text-lg font-semibold hover:underline" x-text="course.name"
                       :href="`/course/${course.year}/${course.term}/${course.slug}`"></a>
                    <div class="flex items-center text-sm text-5 font-light">
                             <span x-cloak x-show="course.nextLecture.ID !== 0"
                                   x-text="`Next lecture: ${new Date(course.nextLecture.Start).toLocaleString()}`"></span>
                        <span x-cloak x-show="course.nextLecture.ID === 0">No upcoming lecture.</span>
                        <a x-cloak x-show="course.lastLecture.ID !== 0"
                           :href="`/w/${course.slug}/${course.lastLecture.ID}`"
                           class="text-5 text-sm px-3">
                            <i class="fa-solid fa-square-up-right"></i>
                            <span class="hover:underline">Most recent lecture</span>
                        </a>
                    </div>
                </article>
            </template>
            <a href="#my-courses-head"
               class="text-3 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full px-2 py-1 mx-auto">
                Go back up
                <i class="fa-solid fa-chevron-up ml-2"></i>
            </a>
        </section>
    </article>
{{end}}

{{define "public-courses"}}
    <div id="public-courses">
        <div class="flex items-center justify-between mb-4">
            <h1 id="my-courses-heading" class="flex items-center font-bold px-3">
                <i class="text-base fa-solid fa-chalkboard mr-2"></i>
                Public Courses
            </h1>
            <button type="button" title="Navigate to start"
                    class="text-3 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full px-2 py-1"
                    @click="showMain()">
                <i class="fa-solid fa-undo mr-2"></i>
                <span>Go back</span>
            </button>
        </div>
        <div class="grid gap-3 pb-4">
            <template x-for="(course, i) in publicCourses" :key="course.ID">
                <div class="hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg px-3 py-2">
                    <a class="block text-3 text-lg font-semibold hover:underline" x-text="course.name"
                       :href="`/course/${course.year}/${course.term}/${course.slug}`"></a>
                    <div class="flex items-center text-sm text-5 font-light">
                             <span x-cloak x-show="course.nextLecture.ID !== 0"
                                   x-text="`Next lecture: ${new Date(course.nextLecture.Start).toLocaleString()}`"></span>
                        <span x-cloak x-show="course.nextLecture.ID === 0">No upcoming lecture.</span>
                        <a x-cloak x-show="course.lastLecture.ID !== 0"
                           :href="`/w/${course.slug}/${course.lastLecture.ID}`"
                           class="text-5 text-sm px-3">
                            <i class="fa-solid fa-square-up-right"></i>
                            <span class="hover:underline">Most recent lecture</span>
                        </a>
                    </div>
                </div>
            </template>
            <a href="#my-courses-heading"
               class="text-3 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full px-2 py-1 mx-auto">
                Go back up
                <i class="fa-solid fa-chevron-up ml-2"></i>
            </a>
        </div>
    </div>
{{end}}
